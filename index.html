<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto Digital - Tu Tienda de Servicios Digitales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-dark: #0D1117;
            --background-light: #161B22;
            --border-color: #30363d;
            --primary-purple: #8B5CF6;
            --primary-glow: rgba(139, 92, 246, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .product-card {
            background-color: var(--background-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        .nav-link.active {
            color: var(--primary-purple);
            font-weight: 600;
        }
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        #payment-qr-image {
            border-radius: 0.5rem;
            border: 4px solid var(--primary-purple);
        }
        @keyframes pulse-bg {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .announcement-bar {
            background: linear-gradient(90deg, #8b5cf6, #ec4899, #f59e0b, #8b5cf6);
            background-size: 200% 200%;
            animation: pulse-bg 5s ease infinite;
        }
    </style>
</head>
<body class="text-gray-300">

    <!-- Global Announcement Bar -->
    <div id="announcement-bar" class="announcement-bar text-white text-center p-2 font-semibold text-sm hidden">
        <span id="announcement-text"></span>
    </div>

    <!-- Header -->
    <header class="bg-gray-900/80 backdrop-blur-sm shadow-lg sticky top-0 z-40 border-b border-gray-800">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-white"><a href="#">Punto Digital</a></h1>
            <div class="flex-1 max-w-xl mx-4">
                <div class="relative">
                    <input id="search-input" type="search" placeholder="Buscar productos..." class="w-full bg-gray-800 text-white border-gray-700 rounded-md py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="purchases-button" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Mis Compras</button>
                <button id="login-register-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Login</button>
                <button id="logout-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Salir</button>
            </div>
        </div>
        <nav class="bg-gray-800/80 border-t border-gray-800">
            <div class="container mx-auto px-4 py-2 flex space-x-6 text-sm font-medium">
                <a href="#all" class="text-white hover:text-purple-400 nav-link active" data-category="Todos">Todo</a>
                <a href="#streaming" class="text-gray-400 hover:text-purple-400 nav-link" data-category="Streaming">Streaming</a>
                <a href="#software" class="text-gray-400 hover:text-purple-400 nav-link" data-category="Software">Software</a>
                <a href="#accounts" class="text-gray-400 hover:text-purple-400 nav-link" data-category="Cuentas Premium">Cuentas Premium</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center">
            <h2 id="category-title" class="text-3xl font-bold text-white mb-6">Explorando: Todo</h2>
            <button id="admin-panel-button" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mb-6">Gestionar Tienda</button>
        </div>
        <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 mt-12 py-6 border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-500 text-sm">&copy; 2025 Punto Digital. Todos los derechos reservados.</div>
    </footer>

    <!-- Modals -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4 relative"><button id="close-auth-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-6">Bienvenido</h3><div class="space-y-4"><button id="show-login-form-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md">Iniciar Sesión</button><button id="show-register-form-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md">Registrarse</button></div></div></div>
    <div id="login-form-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4 relative"><button id="close-login-form-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-6">Iniciar Sesión</h3><form id="login-form"><div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-400 mb-2">Email</label><input type="email" id="email" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-400 mb-2">Contraseña</label><input type="password" id="password" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Ingresar</button><p id="login-error" class="text-red-500 text-center text-sm mt-4"></p></form></div></div>
    <div id="register-form-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4 relative"><button id="close-register-form-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-6">Crear Cuenta</h3><form id="register-form"><div class="mb-4"><label for="register-name" class="block text-sm font-medium text-gray-400 mb-2">Nombre</label><input type="text" id="register-name" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-400 mb-2">Email</label><input type="email" id="register-email" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><div class="mb-4"><label for="register-password" class="block text-sm font-medium text-gray-400 mb-2">Contraseña</label><input type="password" id="register-password" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><div class="mb-6"><label for="register-confirm-password" class="block text-sm font-medium text-gray-400 mb-2">Confirmar Contraseña</label><input type="password" id="register-confirm-password" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Registrarse</button><p id="register-error" class="text-red-500 text-center text-sm mt-4"></p></form></div></div>
    <div id="payment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4 relative"><button id="close-payment-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-2" id="payment-product-name"></h3><p class="text-center text-purple-400 font-bold text-3xl mb-4" id="payment-product-price"></p><img id="payment-qr-image" src="https://placehold.co/256x256/161B22/E9D5FF?text=QR+Yape" alt="Código QR de Yape" class="w-48 h-48 mx-auto my-4 object-contain"><p class="text-center text-gray-400 text-sm">Escanea el código QR para pagar.</p><div class="my-6 border-t border-gray-700"></div><p class="text-center text-gray-400 text-sm mb-3">Luego, envía tu captura de pantalla a nuestro WhatsApp:</p><p class="text-center font-semibold text-white text-lg mb-4">51 910 937 843</p><a id="whatsapp-link" href="#" target="_blank" class="w-full inline-flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg"><svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zM6.597 20.193c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg><span>Enviar Captura por WhatsApp</span></a></div></div>
    <div id="purchases-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 relative max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700"><h3 class="text-2xl font-bold text-white">Mi Historial de Compras</h3><button id="close-purchases-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="purchases-list" class="flex-grow overflow-y-auto space-y-4"></div></div></div>
    <div id="admin-panel-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-6 max-w-7xl w-full mx-4 relative max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700"><h3 class="text-2xl font-bold text-white">Panel de Administración</h3><button id="close-admin-panel-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="flex-grow overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-x-8"><div class="flex flex-col space-y-8"><section><h4 class="text-xl font-semibold text-white mb-4">Gestionar Productos</h4><div class="overflow-y-auto mb-6 max-h-[40vh]"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0"><tr><th scope="col" class="px-4 py-3">Producto</th><th scope="col" class="px-4 py-3">Precio</th><th scope="col" class="px-4 py-3">Stock</th><th scope="col" class="px-4 py-3" colspan="2">Acciones</th></tr></thead><tbody id="admin-products-table"></tbody></table></div><h4 class="text-xl font-semibold text-white mb-4">Agregar Nuevo Producto</h4><form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-900 p-4 rounded-lg"><div><label for="new-product-name" class="block text-sm font-medium mb-1">Nombre</label><input type="text" id="new-product-name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" required></div><div><label for="new-product-image" class="block text-sm font-medium mb-1">URL de Imagen</label><input type="url" id="new-product-image" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" required></div><div><label for="new-product-category" class="block text-sm font-medium mb-1">Categoría</label><select id="new-product-category" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" required><option value="Streaming">Streaming</option><option value="Software">Software</option><option value="Cuentas Premium">Cuentas Premium</option></select></div><div><label for="new-product-price" class="block text-sm font-medium mb-1">Precio</label><input type="number" id="new-product-price" step="0.01" min="0" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" required></div><div><label for="new-product-stock" class="block text-sm font-medium mb-1">Stock</label><input type="number" id="new-product-stock" min="0" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" required></div><div class="flex items-end"><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-sm">Agregar Producto</button></div></form></section><section><h4 class="text-xl font-semibold text-white mb-4">Configuraciones Globales</h4><div class="bg-gray-900 p-4 rounded-lg space-y-4"><form id="yape-qr-form"><label for="yape-qr-url-input" class="block text-sm font-medium mb-2">URL de Imagen QR Yape</label><div class="flex items-center space-x-2"><input type="url" id="yape-qr-url-input" placeholder="https://ejemplo.com/qr.png" class="flex-grow w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Guardar</button></div></form><form id="announcement-form"><label for="announcement-input" class="block text-sm font-medium mb-2">Mensaje de Anuncio Global</label><div class="flex items-center space-x-2"><input type="text" id="announcement-input" placeholder="¡Ofertas solo por hoy!" class="flex-grow w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Publicar</button><button type="button" id="remove-announcement-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">Quitar</button></div></form></div></section></div><div class="flex flex-col"><div class="flex justify-between items-center mb-4"><h4 class="text-xl font-semibold text-white">Gestionar Usuarios</h4><div class="relative"><input type="search" id="user-search-input" placeholder="Buscar por email..." class="bg-gray-700 border border-gray-600 rounded-md py-1 pl-8 pr-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"><svg class="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div></div><div class="flex-grow overflow-y-auto max-h-[80vh]"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0"><tr><th scope="col" class="px-4 py-3">Nombre</th><th scope="col" class="px-4 py-3">Email</th><th scope="col" class="px-4 py-3" colspan="2">Acción</th></tr></thead><tbody id="admin-users-table"></tbody></table></div></div></div></div></div>
    <div id="add-purchase-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 relative"><button id="close-add-purchase-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-2">Agregar Compra Manual</h3><p id="add-purchase-user-info" class="text-center text-gray-400 mb-6"></p><form id="add-purchase-form"><div class="mb-4"><label for="product-select" class="block text-sm font-medium text-gray-400 mb-2">Seleccionar Producto</label><select id="product-select" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white" required></select></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Confirmar Compra</button></form></div></div>
    <div id="user-purchases-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop"><div class="bg-gray-800 rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 relative max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700"><h3 id="user-purchases-title" class="text-2xl font-bold text-white"></h3><button id="close-user-purchases-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="user-purchases-list" class="flex-grow overflow-y-auto space-y-4"></div></div></div>
    
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <!-- SCRIPT: Firebase v10 Modular -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config (Your Original, Correct Config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAu_NVkoTn6ZSsmrGp1lsiImtWwB3HvkJo",
            authDomain: "punto-digital-tienda.firebaseapp.com",
            projectId: "punto-digital-tienda",
            storageBucket: "punto-digital-tienda.firebasestorage.app",
            messagingSenderId: "404585258817",
            appId: "1:404585258817:web:569e29256cca5228b90bc0",
            measurementId: "G-JTQDQ6JWTM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Element References ---
        const productsGrid = document.getElementById('products-grid');
        const navLinks = document.querySelectorAll('.nav-link');
        const searchInput = document.getElementById('search-input');
        const categoryTitle = document.getElementById('category-title');
        const loginRegisterButton = document.getElementById('login-register-button');
        const logoutButton = document.getElementById('logout-button');
        const purchasesButton = document.getElementById('purchases-button');
        const announcementBar = { el: document.getElementById('announcement-bar'), text: document.getElementById('announcement-text') };

        // --- Modals ---
        const authModal = { el: document.getElementById('auth-modal'), close: document.getElementById('close-auth-modal') };
        const loginModal = { el: document.getElementById('login-form-modal'), close: document.getElementById('close-login-form-modal'), form: document.getElementById('login-form'), error: document.getElementById('login-error') };
        const registerModal = { el: document.getElementById('register-form-modal'), close: document.getElementById('close-register-form-modal'), form: document.getElementById('register-form'), error: document.getElementById('register-error') };
        const paymentModal = { el: document.getElementById('payment-modal'), close: document.getElementById('close-payment-modal'), name: document.getElementById('payment-product-name'), price: document.getElementById('payment-product-price'), qrImage: document.getElementById('payment-qr-image'), whatsappLink: document.getElementById('whatsapp-link') };
        const purchasesModal = { el: document.getElementById('purchases-modal'), close: document.getElementById('close-purchases-modal'), list: document.getElementById('purchases-list') };
        const adminPanelModal = { el: document.getElementById('admin-panel-modal'), close: document.getElementById('close-admin-panel-modal'), productsTable: document.getElementById('admin-products-table'), usersTable: document.getElementById('admin-users-table'), addProductForm: document.getElementById('add-product-form'), button: document.getElementById('admin-panel-button'), yapeQrForm: document.getElementById('yape-qr-form'), yapeQrInput: document.getElementById('yape-qr-url-input'), announcementForm: document.getElementById('announcement-form'), announcementInput: document.getElementById('announcement-input'), removeAnnouncementButton: document.getElementById('remove-announcement-button'), userSearchInput: document.getElementById('user-search-input') };
        const addPurchaseModal = { el: document.getElementById('add-purchase-modal'), close: document.getElementById('close-add-purchase-modal'), form: document.getElementById('add-purchase-form'), userInfo: document.getElementById('add-purchase-user-info'), productSelect: document.getElementById('product-select') };
        const userPurchasesModal = { el: document.getElementById('user-purchases-modal'), close: document.getElementById('close-user-purchases-modal'), title: document.getElementById('user-purchases-title'), list: document.getElementById('user-purchases-list') };
        
        const showLoginFormButton = document.getElementById('show-login-form-button');
        const showRegisterFormButton = document.getElementById('show-register-form-button');

        let allProducts = [];
        let allUsers = [];
        let currentUserData = null;
        let userToManage = null;
        let yapeQrUrl = 'https://placehold.co/256x256/161B22/E9D5FF?text=QR+Yape'; // Default QR

        // --- Utilities ---
        const openModal = (modal) => modal.el.classList.remove('hidden');
        const closeModal = (modal) => modal.el.classList.add('hidden');
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };
        
        // --- RENDER FUNCTIONS ---
        const renderProducts = (category = 'Todos', searchTerm = '') => {
            productsGrid.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredProducts = allProducts.filter(p => (category === 'Todos' || p.category === category) && p.name.toLowerCase().includes(lowerCaseSearchTerm));
            if (filteredProducts.length === 0) { productsGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full">No se encontraron productos.</p>`; return; }
            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card rounded-lg p-4 flex flex-col h-full';
                const isOutOfStock = product.stock === 0;
                card.innerHTML = `<div class="flex-1"><div class="flex items-center space-x-4"><div class="flex-shrink-0 w-12 h-12 bg-gray-800 rounded-md flex items-center justify-center p-1"><img src="${product.imageUrl}" alt="Logo de ${product.name}" class="h-8 w-8 object-contain"></div><p class="font-semibold text-white">${product.name}</p></div></div><div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">${isOutOfStock ? `<div class="text-left"><p class="font-bold text-lg text-red-500">Agotado</p></div><button class="text-sm bg-red-800 text-white font-semibold py-2 px-4 rounded-md cursor-not-allowed" disabled>Agotado</button>`:`<div class="text-left"><p class="font-bold text-lg text-purple-400">$${product.price.toFixed(2)}</p><p class="text-xs text-gray-400">Disponible</p></div><button data-product-id="${product.id}" class="buy-button text-sm bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md transition-colors">Comprar</button>`}</div>`;
                productsGrid.appendChild(card);
            });
        };

        const renderAdminProducts = () => {
            adminPanelModal.productsTable.innerHTML = '';
            allProducts.sort((a, b) => a.name.localeCompare(b.name)).forEach(product => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700';
                row.innerHTML = `<td class="px-4 py-3 font-medium text-white">${product.name}</td><td class="px-4 py-3"><input type="number" value="${product.price.toFixed(2)}" class="price-input bg-gray-900 border border-gray-600 rounded p-1 w-20" data-id="${product.id}" step="0.01"></td><td class="px-4 py-3"><input type="number" value="${product.stock}" class="stock-input bg-gray-900 border border-gray-600 rounded p-1 w-20" data-id="${product.id}"></td><td class="px-4 py-3"><button class="save-button bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded" data-id="${product.id}">Guardar</button></td><td class="px-4 py-3"><button class="delete-button bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded" data-id="${product.id}">Eliminar</button></td>`;
                adminPanelModal.productsTable.appendChild(row);
            });
        };
        
        const renderAdminUsers = (searchTerm = '') => {
            adminPanelModal.usersTable.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredUsers = allUsers.filter(user => user.email.toLowerCase().includes(lowerCaseSearchTerm));
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700';
                row.innerHTML = `<td class="px-4 py-3 font-medium text-white">${user.name}</td><td class="px-4 py-3">${user.email}</td><td class="px-4 py-3"><button class="view-purchases-button bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-1 px-3 rounded mr-2" data-user-id="${user.id}" data-user-name="${user.name}">Ver Compras</button><button class="add-purchase-button bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded" data-user-id="${user.id}" data-user-name="${user.name}">Añadir Compra</button></td>`;
                adminPanelModal.usersTable.appendChild(row);
            });
        };

        // --- FIREBASE REALTIME LISTENERS ---
        onSnapshot(doc(db, 'settings', 'payment'), (docSnap) => {
            if (docSnap.exists() && docSnap.data().yapeQrUrl) yapeQrUrl = docSnap.data().yapeQrUrl;
        });

        onSnapshot(doc(db, 'settings', 'announcement'), (docSnap) => {
            if (docSnap.exists() && docSnap.data().message) {
                announcementBar.text.textContent = docSnap.data().message;
                announcementBar.el.classList.remove('hidden');
            } else {
                announcementBar.el.classList.add('hidden');
            }
        });

        onSnapshot(collection(db, 'products'), (snapshot) => {
            allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const activeCategory = document.querySelector('.nav-link.active')?.dataset.category || 'Todos';
            renderProducts(activeCategory, searchInput.value);
            if (currentUserData?.role === 'admin') renderAdminProducts();
        });
        
        const listenForUsers = () => {
            const q = query(collection(db, 'users'), where('role', '==', 'user'));
            onSnapshot(q, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUserData?.role === 'admin') renderAdminUsers(adminPanelModal.userSearchInput.value);
            });
        };
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = userDocSnap.exists() ? { uid: user.uid, ...userDocSnap.data() } : { uid: user.uid, email: user.email, name: user.email.split('@')[0], role: 'admin' };
                
                loginRegisterButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');

                if (currentUserData.role === 'admin') {
                    adminPanelModal.button.classList.remove('hidden');
                    const paymentSettingsDoc = await getDoc(doc(db, 'settings', 'payment'));
                    if(paymentSettingsDoc.exists()) adminPanelModal.yapeQrInput.value = paymentSettingsDoc.data().yapeQrUrl;
                    listenForUsers();
                } else {
                    purchasesButton.classList.remove('hidden');
                }
                [authModal, loginModal, registerModal].forEach(closeModal);
            } else {
                currentUserData = null;
                loginRegisterButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                adminPanelModal.button.classList.add('hidden');
                purchasesButton.classList.add('hidden');
            }
        });

        // --- EVENT LISTENERS ---
        // Modals
        [authModal, loginModal, registerModal, paymentModal, purchasesModal, adminPanelModal, addPurchaseModal, userPurchasesModal].forEach(modal => {
            modal.close?.addEventListener('click', () => closeModal(modal));
        });
        loginRegisterButton.addEventListener('click', () => openModal(authModal));
        showLoginFormButton.addEventListener('click', () => { closeModal(authModal); openModal(loginModal); });
        showRegisterFormButton.addEventListener('click', () => { closeModal(authModal); openModal(registerModal); });
        logoutButton.addEventListener('click', () => signOut(auth));

        // Forms
        loginModal.form.addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, loginModal.form.email.value, loginModal.form.password.value).catch(err => { loginModal.error.textContent = 'Error: Credenciales incorrectas.'; }); });
        registerModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const [name, email, password, confirm] = [e.target['register-name'].value, e.target['register-email'].value, e.target['register-password'].value, e.target['register-confirm-password'].value];
            registerModal.error.textContent = '';
            if (password !== confirm) { registerModal.error.textContent = 'Las contraseñas no coinciden.'; return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), { name, email, role: 'user' });
                showToast('¡Usuario creado correctamente!');
                closeModal(registerModal);
            } catch(err) {
                registerModal.error.textContent = 'Error al registrar: ' + err.message;
            }
        });

        // Purchase Flow
        productsGrid.addEventListener('click', async (e) => {
            if (e.target.classList.contains('buy-button')) {
                if (!currentUserData) { showToast('Debes iniciar sesión para comprar', 'error'); openModal(authModal); return; }
                const product = allProducts.find(p => p.id === e.target.dataset.productId);
                paymentModal.name.textContent = product.name;
                paymentModal.price.textContent = `$${product.price.toFixed(2)}`;
                const paymentSettingsDoc = await getDoc(doc(db, 'settings', 'payment'));
                paymentModal.qrImage.src = paymentSettingsDoc.exists() ? paymentSettingsDoc.data().yapeQrUrl : yapeQrUrl;
                const whatsappMessage = `Hola, realicé la compra de "${product.name}" por $${product.price.toFixed(2)}. Adjunto mi captura.`;
                paymentModal.whatsappLink.href = `https://wa.me/51910937843?text=${encodeURIComponent(whatsappMessage)}`;
                paymentModal.whatsappLink.onclick = async () => { 
                    await addDoc(collection(db, 'purchases'), { userId: currentUserData.uid, productId: product.id, productName: product.name, price: product.price, purchaseDate: serverTimestamp() }); 
                };
                openModal(paymentModal);
            }
        });
        
        // User: View Purchases
        purchasesButton.addEventListener('click', async () => {
            if (!currentUserData) return;
            purchasesModal.list.innerHTML = '<p>Cargando tus compras...</p>';
            openModal(purchasesModal);
            const q = query(collection(db, 'purchases'), where('userId', '==', currentUserData.uid));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { purchasesModal.list.innerHTML = '<p>No has realizado ninguna compra todavía.</p>'; return; }
            const purchases = querySnapshot.docs.map(d => d.data()).filter(p => p.purchaseDate).sort((a,b) => b.purchaseDate.toDate() - a.purchaseDate.toDate());
            purchasesModal.list.innerHTML = '';
            purchases.forEach(p => {
                const date = p.purchaseDate.toDate().toLocaleDateString();
                const el = document.createElement('div');
                el.className = 'bg-gray-900 p-4 rounded-lg flex justify-between items-center';
                el.innerHTML = `<div><p class="font-semibold text-white">${p.productName}</p><p class="text-sm text-gray-400">Fecha: ${date}</p></div><p class="font-bold text-purple-400">$${p.price.toFixed(2)}</p>`;
                purchasesModal.list.appendChild(el);
            });
        });
        
        // Admin Panel
        adminPanelModal.button.addEventListener('click', () => openModal(adminPanelModal));
        adminPanelModal.productsTable.addEventListener('click', async (e) => {
            const button = e.target;
            const id = button.dataset.id;
            if (button.classList.contains('save-button')) {
                const price = parseFloat(document.querySelector(`.price-input[data-id="${id}"]`).value);
                const stock = parseInt(document.querySelector(`.stock-input[data-id="${id}"]`).value, 10);
                await updateDoc(doc(db, 'products', id), { price, stock });
                showToast('¡Producto actualizado!');
            } else if (button.classList.contains('delete-button')) {
                if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                    await deleteDoc(doc(db, 'products', id));
                    showToast('¡Producto eliminado!');
                }
            }
        });
        adminPanelModal.addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const newProduct = { name: form['new-product-name'].value, imageUrl: form['new-product-image'].value, category: form['new-product-category'].value, price: parseFloat(form['new-product-price'].value), stock: parseInt(form['new-product-stock'].value, 10), seller: 'PuntoDigital', deliveryTime: 'Inmediata' };
            await addDoc(collection(db, 'products'), newProduct);
            showToast('¡Producto agregado!');
            form.reset();
        });
        adminPanelModal.yapeQrForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUrl = adminPanelModal.yapeQrInput.value;
            if (newUrl && newUrl.startsWith('http')) {
                await setDoc(doc(db, 'settings', 'payment'), { yapeQrUrl: newUrl }, { merge: true });
                showToast('URL del QR guardada');
            } else { showToast('Por favor, ingresa una URL válida.', 'error'); }
        });
        adminPanelModal.announcementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = adminPanelModal.announcementInput.value;
            if(message) {
                await setDoc(doc(db, 'settings', 'announcement'), { message });
                showToast('Anuncio publicado');
            }
        });
        adminPanelModal.removeAnnouncementButton.addEventListener('click', async () => {
            await deleteDoc(doc(db, 'settings', 'announcement'));
            showToast('Anuncio eliminado');
        });
        adminPanelModal.userSearchInput.addEventListener('input', (e) => renderAdminUsers(e.target.value));

        // Admin: Manage Users
        adminPanelModal.usersTable.addEventListener('click', async (e) => {
            const button = e.target;
            const userId = button.dataset.userId;
            const userName = button.dataset.userName;

            if (button.classList.contains('add-purchase-button')) {
                userToManage = { id: userId, name: userName };
                addPurchaseModal.userInfo.textContent = `Asignar compra a: ${userName}`;
                addPurchaseModal.productSelect.innerHTML = allProducts.map(p => `<option value="${p.id}">${p.name} - $${p.price.toFixed(2)}</option>`).join('');
                openModal(addPurchaseModal);
            } else if (button.classList.contains('view-purchases-button')) {
                userPurchasesModal.title.textContent = `Compras de ${userName}`;
                userPurchasesModal.list.innerHTML = '<p>Cargando compras...</p>';
                openModal(userPurchasesModal);
                const q = query(collection(db, 'purchases'), where('userId', '==', userId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { userPurchasesModal.list.innerHTML = '<p>Este usuario no tiene compras.</p>'; return; }
                const purchases = querySnapshot.docs.map(d => d.data()).filter(p => p.purchaseDate).sort((a, b) => b.purchaseDate.toDate() - a.purchaseDate.toDate());
                userPurchasesModal.list.innerHTML = '';
                purchases.forEach(p => {
                    const date = p.purchaseDate.toDate().toLocaleDateString();
                    const el = document.createElement('div');
                    el.className = 'bg-gray-900 p-4 rounded-lg flex justify-between items-center';
                    el.innerHTML = `<div><p class="font-semibold text-white">${p.productName}</p><p class="text-sm text-gray-400">Fecha: ${date}</p></div><p class="font-bold text-purple-400">$${p.price.toFixed(2)}</p>`;
                    userPurchasesModal.list.appendChild(el);
                });
            }
        });
        addPurchaseModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = addPurchaseModal.productSelect.value;
            const product = allProducts.find(p => p.id === productId);
            await addDoc(collection(db, 'purchases'), { userId: userToManage.id, productId: product.id, productName: product.name, price: product.price, purchaseDate: serverTimestamp() });
            showToast(`Compra agregada a ${userToManage.name}`);
            closeModal(addPurchaseModal);
        });
        
        // Navigation & Search
        const updateCategory = (category) => { navLinks.forEach(l => l.classList.remove('active', 'text-white')); document.querySelector(`.nav-link[data-category="${category}"]`)?.classList.add('active', 'text-white'); categoryTitle.textContent = `Explorando: ${category}`; renderProducts(category, searchInput.value); };
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); updateCategory(e.target.dataset.category); }); });
        searchInput.addEventListener('input', () => { const activeCategory = document.querySelector('.nav-link.active').dataset.category; renderProducts(activeCategory, searchInput.value); });
    </script>
</body>
</html>

